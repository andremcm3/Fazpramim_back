{% extends 'base.html' %}
{% block content %}

{% if user == request_obj.provider.user %}
<p><a href="{% url 'provider_requests' %}">&larr; Voltar √†s Solicita√ß√µes</a></p>
{% elif user == request_obj.client %}
<p><a href="{% url 'client_requests' %}">&larr; Voltar √†s Minhas Solicita√ß√µes</a></p>
{% else %}
<p><a href="{% url 'my_profile' %}">&larr; Voltar ao Perfil</a></p>
{% endif %}

<div style="max-width:800px; margin:2rem auto; padding:2rem; border:1px solid #ddd; border-radius:12px; background:#fff;">
    <div style="display:flex; justify-content:space-between; align-items:start; margin-bottom:1.5rem;">
        <h1 style="margin:0;">Solicita√ß√£o #{{ request_obj.id }}</h1>
        <span style="padding:0.5rem 1rem; border-radius:6px; font-weight:600; background:{% if request_obj.status == 'pending' %}#FFA500{% elif request_obj.status == 'accepted' %}#28A745{% elif request_obj.status == 'completed' %}#007BFF{% else %}#DC3545{% endif %}; color:white;">
            {{ request_obj.get_status_display }}
        </span>
    </div>

    <div style="display:grid; gap:1rem; margin-bottom:2rem;">
        <div style="padding:1rem; background:#f9f9f9; border-radius:8px;">
            <p style="margin:0; color:#666; font-size:0.9rem;">Prestador</p>
            <p style="margin:0.25rem 0 0 0; font-weight:600; font-size:1.1rem;">{{ request_obj.provider.full_name }}</p>
        </div>

        <div style="padding:1rem; background:#f9f9f9; border-radius:8px;">
            <p style="margin:0; color:#666; font-size:0.9rem;">Cliente</p>
            <p style="margin:0.25rem 0 0 0; font-weight:600;">{{ request_obj.client.username }}</p>
            <p style="margin:0.25rem 0 0 0; color:#666;">{{ request_obj.client.email }}</p>
        </div>

        <div style="padding:1rem; background:#f9f9f9; border-radius:8px;">
            <p style="margin:0; color:#666; font-size:0.9rem;">Descri√ß√£o do Servi√ßo</p>
            <p style="margin:0.5rem 0 0 0;">{{ request_obj.description|linebreaks }}</p>
        </div>

        {% if request_obj.desired_datetime %}
        <div style="padding:1rem; background:#f9f9f9; border-radius:8px;">
            <p style="margin:0; color:#666; font-size:0.9rem;">Hor√°rio Desejado</p>
            <p style="margin:0.25rem 0 0 0; font-weight:600;">{{ request_obj.desired_datetime|date:"d/m/Y H:i" }}</p>
        </div>
        {% endif %}

        {% if request_obj.proposed_value %}
        <div style="padding:1rem; background:#f9f9f9; border-radius:8px;">
            <p style="margin:0; color:#666; font-size:0.9rem;">Valor Proposto</p>
            <p style="margin:0.25rem 0 0 0; font-weight:600; font-size:1.2rem; color:#28A745;">R$ {{ request_obj.proposed_value }}</p>
        </div>
        {% endif %}

        <div style="padding:1rem; background:#f9f9f9; border-radius:8px;">
            <p style="margin:0; color:#666; font-size:0.9rem;">Data da Solicita√ß√£o</p>
            <p style="margin:0.25rem 0 0 0;">{{ request_obj.created_at|date:"d/m/Y H:i" }}</p>
        </div>
    </div>

    {% if user.is_authenticated %}
    {% if user == request_obj.provider.user %}
        {% if request_obj.status == 'pending' %}
            <div style="display:flex; gap:1rem; padding-top:1.5rem; border-top:2px solid #ddd;">
                <form method="post" action="" style="flex:1;">
                    {% csrf_token %}
                    <button name="action" value="accept" type="submit" style="width:100%; padding:1rem; background:#28A745; color:white; border:none; border-radius:8px; cursor:pointer; font-size:1rem; font-weight:600;">
                        ‚úì Aceitar Solicita√ß√£o
                    </button>
                </form>
                <form method="post" action="" style="flex:1;">
                    {% csrf_token %}
                    <button name="action" value="reject" type="submit" style="width:100%; padding:1rem; background:#DC3545; color:white; border:none; border-radius:8px; cursor:pointer; font-size:1rem; font-weight:600;">
                        ‚úó Rejeitar Solicita√ß√£o
                    </button>
                </form>
            </div>
        {% elif request_obj.status == 'accepted' %}
            <div style="padding-top:1.5rem; border-top:2px solid #ddd; display:flex; flex-direction:column; gap:1rem;">
                <a href="{% url 'chat_view' request_obj.id %}" style="display:block; padding:1rem; background:#4A90E2; color:white; text-decoration:none; border-radius:8px; text-align:center; font-size:1rem; font-weight:600;">
                    üí¨ Abrir Chat com o Cliente
                </a>
                {% if request_obj.completed_by_provider %}
                    <div style="padding:1rem; background:#d4edda; border:1px solid #28A745; border-radius:8px; text-align:center;">
                        <p style="margin:0; color:#155724; font-weight:600;">‚úì Voc√™ marcou este servi√ßo como conclu√≠do</p>
                        {% if not request_obj.completed_by_client %}
                            <p style="margin:0.5rem 0 0 0; color:#155724; font-size:0.9rem;">Aguardando confirma√ß√£o do cliente</p>
                        {% endif %}
                    </div>
                {% else %}
                    <form method="post" action="{% url 'complete_service' request_obj.id %}">
                        {% csrf_token %}
                        <button type="submit" style="width:100%; padding:1rem; background:#28A745; color:white; border:none; border-radius:8px; cursor:pointer; font-size:1rem; font-weight:600;">
                            ‚úì Marcar Servi√ßo como Conclu√≠do
                        </button>
                    </form>
                    {% if request_obj.completed_by_client %}
                        <div style="padding:0.75rem; background:#fff3cd; border:1px solid #FF8C00; border-radius:8px; text-align:center;">
                            <p style="margin:0; color:#856404; font-size:0.9rem;">‚ö†Ô∏è O cliente j√° marcou como conclu√≠do. Confirme para finalizar.</p>
                        </div>
                    {% endif %}
                {% endif %}
            </div>
        {% elif request_obj.status == 'completed' %}
            <div style="padding:1rem; background:#d1ecf1; border:2px solid #007BFF; border-radius:8px; text-align:center; color:#0c5460; font-weight:600;">
                ‚úì Servi√ßo conclu√≠do com sucesso!
            </div>
            <div style="padding-top:1rem; display:flex; flex-direction:column; gap:1rem;">
                <a href="{% url 'chat_view' request_obj.id %}" style="display:block; padding:1rem; background:#6c757d; color:white; text-decoration:none; border-radius:8px; text-align:center; font-size:1rem; font-weight:600;">
                    üí¨ Ver Hist√≥rico do Chat
                </a>
                {% if request_obj.review %}
                    {% if request_obj.review.provider_has_reviewed %}
                        <div style="padding:1rem; background:#fff3cd; border:1px solid #FFC107; border-radius:8px;">
                            <p style="margin:0 0 0.5rem 0; font-weight:600; color:#856404;">‚úì Voc√™ j√° avaliou este cliente</p>
                            <div style="font-size:1.5rem; color:#FFC107;">
                                {% for i in "12345" %}
                                    {% if forloop.counter <= request_obj.review.provider_rating %}‚òÖ{% else %}‚òÜ{% endif %}
                                {% endfor %}
                            </div>
                        </div>
                    {% else %}
                        <a href="{% url 'review_service' request_obj.id %}" style="display:block; padding:1rem; background:#FFC107; color:#000; text-decoration:none; border-radius:8px; text-align:center; font-size:1rem; font-weight:600;">
                            ‚≠ê Avaliar Cliente
                        </a>
                    {% endif %}
                {% else %}
                    <a href="{% url 'review_service' request_obj.id %}" style="display:block; padding:1rem; background:#FFC107; color:#000; text-decoration:none; border-radius:8px; text-align:center; font-size:1rem; font-weight:600;">
                        ‚≠ê Avaliar Cliente
                    </a>
                {% endif %}
            </div>
        {% else %}
            <div style="padding:1rem; background:#f8d7da; border-radius:8px; text-align:center; color:#721c24; font-weight:600;">
                Solicita√ß√£o rejeitada.
            </div>
        {% endif %}
    {% elif user == request_obj.client %}
        {% if request_obj.status == 'accepted' %}
            <div style="padding-top:1.5rem; border-top:2px solid #ddd; display:flex; flex-direction:column; gap:1rem;">
                <a href="{% url 'chat_view' request_obj.id %}" style="display:block; padding:1rem; background:#4A90E2; color:white; text-decoration:none; border-radius:8px; text-align:center; font-size:1rem; font-weight:600;">
                    üí¨ Abrir Chat com o Prestador
                </a>
                {% if request_obj.completed_by_client %}
                    <div style="padding:1rem; background:#d4edda; border:1px solid #28A745; border-radius:8px; text-align:center;">
                        <p style="margin:0; color:#155724; font-weight:600;">‚úì Voc√™ marcou este servi√ßo como conclu√≠do</p>
                        {% if not request_obj.completed_by_provider %}
                            <p style="margin:0.5rem 0 0 0; color:#155724; font-size:0.9rem;">Aguardando confirma√ß√£o do prestador</p>
                        {% endif %}
                    </div>
                {% else %}
                    <form method="post" action="{% url 'complete_service' request_obj.id %}">
                        {% csrf_token %}
                        <button type="submit" style="width:100%; padding:1rem; background:#28A745; color:white; border:none; border-radius:8px; cursor:pointer; font-size:1rem; font-weight:600;">
                            ‚úì Marcar Servi√ßo como Conclu√≠do
                        </button>
                    </form>
                    {% if request_obj.completed_by_provider %}
                        <div style="padding:0.75rem; background:#fff3cd; border:1px solid #FF8C00; border-radius:8px; text-align:center;">
                            <p style="margin:0; color:#856404; font-size:0.9rem;">‚ö†Ô∏è O prestador j√° marcou como conclu√≠do. Confirme para finalizar.</p>
                        </div>
                    {% endif %}
                {% endif %}
            </div>
        {% elif request_obj.status == 'pending' %}
            <div style="padding:1rem; background:#fff3cd; border-radius:8px; text-align:center; color:#856404;">
                Voc√™ enviou esta solicita√ß√£o. Aguarde a resposta do prestador.
            </div>
        {% elif request_obj.status == 'completed' %}
            <div style="padding:1rem; background:#d1ecf1; border:2px solid #007BFF; border-radius:8px; text-align:center; color:#0c5460; font-weight:600;">
                ‚úì Servi√ßo conclu√≠do com sucesso!
            </div>
            <div style="padding-top:1rem; display:flex; flex-direction:column; gap:1rem;">
                <a href="{% url 'chat_view' request_obj.id %}" style="display:block; padding:1rem; background:#6c757d; color:white; text-decoration:none; border-radius:8px; text-align:center; font-size:1rem; font-weight:600;">
                    üí¨ Ver Hist√≥rico do Chat
                </a>
                {% if request_obj.review %}
                    {% if request_obj.review.client_has_reviewed %}
                        <div style="padding:1rem; background:#fff3cd; border:1px solid #FFC107; border-radius:8px;">
                            <p style="margin:0 0 0.5rem 0; font-weight:600; color:#856404;">‚úì Voc√™ j√° avaliou este servi√ßo</p>
                            <div style="font-size:1.5rem; color:#FFC107;">
                                {% for i in "12345" %}
                                    {% if forloop.counter <= request_obj.review.client_rating %}‚òÖ{% else %}‚òÜ{% endif %}
                                {% endfor %}
                            </div>
                        </div>
                    {% else %}
                        <a href="{% url 'review_service' request_obj.id %}" style="display:block; padding:1rem; background:#FFC107; color:#000; text-decoration:none; border-radius:8px; text-align:center; font-size:1rem; font-weight:600;">
                            ‚≠ê Avaliar Prestador
                        </a>
                    {% endif %}
                {% else %}
                    <a href="{% url 'review_service' request_obj.id %}" style="display:block; padding:1rem; background:#FFC107; color:#000; text-decoration:none; border-radius:8px; text-align:center; font-size:1rem; font-weight:600;">
                        ‚≠ê Avaliar Prestador
                    </a>
                {% endif %}
            </div>
        {% else %}
            <div style="padding:1rem; background:#f8d7da; border-radius:8px; text-align:center; color:#721c24;">
                Esta solicita√ß√£o foi rejeitada pelo prestador.
            </div>
        {% endif %}
    {% endif %}
    {% endif %}
</div>

{% endblock %}